# 4. CPU의 작동 원리

- CPU의 구성 요소
    - ALU: 계산 담당
    - 제어장치: 명령어를 읽어 들이고 해석 / 제어 신호를 내보냄
    - 레지스터: 임시 저장 장치

## 4.1 ALU와 제어장치

### ALU

- ALU가 계산을 수행하기 위해서는 피연산자와 수행할 연산이 필요함
- **레지스터**를 통해 피연산자를 받아들이고, **제어장치**로부터 수행할 연산을 알려주는 제어 신호를 받아들임
- ALU는 레지스터와 제어장치로부터 받아들인 피연산자와 제어 신호로 산술 연산, 논리 연산 등 다양한 연산을 수행함
- 속도 저하를 방지하기 위해 연산을 수행한 결과는 바로 메모리에 저장되지 않고 일시적으로 레지스터에 저장됨
- ALU는 계산 결과와 더불어 연산 결과에 대한 추가적인 상태 정보를 의미하는 플래그(flag)를 함께 내보냄
    - 부호 플래그: 연산 결과의 부호를 나타냄
    - 제로 플래그: 연산 결과가 0인지 여부를 나타냄
    - 캐리 플래그: 연산 결과 올림수나 빌림수가 발생했는지를 나타냄
    - 오버플로우 플래그: 오버플로우가 발생했는지를 나타냄
    - 인터럽트 플래그: 인터럽트가 가능한지를 나타냄
    - 슈퍼바이저 플래그: 커널 모드로 실행 중인지, 사용자 모드로 실행 중인지를 나타냄
- 플래그는 플래그 레지스터라는 레지스터에 저장됨

### 제어장치

#### 제어장치가 받아들이는 정보

- 클럭 신호
    - 클럭(clock): 컴퓨터의 부품을 일사불란하게 움직일 수 있도록 하는 시간 단위
        - 클럭의 주기에 맞춰 한 레지스터에서 다른 레지스터로 데이터가 이동되거나, ALU에서 연산이 수행되거나, CPU가 메모리에 저장된 명령어를 읽어들임

- 해석해야 할 명령어
    - CPU가 해석해야 할 명령어는 명령어 레지스터에 저장됨
    - 제어장치는 이 명령어 레지스터로부터 해석할 명령어를 받아들이고 해석한 뒤, 제어 신호를 발생시켜 컴퓨터 부품들에 수행해야 할 내용을 알려줌

- 플래그 레지스터 속 플래그 값
    - 제어장치는 플래그 값을 받아들이고 이를 참고하여 제어 신호를 발생시킴

- 시스템 버스 중에서 제어 버스로 전달된 제어 신호
    - 제어 버스를 통해 외부로부터 전달된 제어 신호를 받아들임

#### 제어장치가 내보내는 정보

- CPU 외부에 전달하는 제어 신호
    - 제어 버스로 제어 신호를 내보내는 것
    - 메모리에 전달하는 제어 신호
        - 메모리에 저장된 값을 읽거나 메모리에 새로운 값을 쓰고 싶을 때 내보냄
    - 입출력장치에 전달하는 제어 신호
        - 입출력장치의 값을 읽거나 입출력장치에 새로운 값을 쓰고 싶을 때 내보냄

- CPU 내부에 전달하는 제어 신호
    - ALU에 전달하는 제어 신호
        - 수행할 연산을 지시하기 위해 내보냄
    - 레지스터에 전달하는 제어 신호
        - 레지스터 간에 데이터를 이동시키거나 레지스터에 저장된 명령어를 해석하기 위해 내보냄

## 4.2 레지스터

### 반드시 알아야 할 레지스터

#### 프로그램 카운터(PC; Programme Counter, IP; Instruction Pointer)

- 메모리에서 가져올 명령어의 주소, 즉 메모리에서 읽어 들일 명령어의 주소를 저장

#### 명령어 레지스터(IR; Instruction Register)

- 메모리에서 읽어 들인 명령어를 저장하는 레지스터
- 제어장치는 명령어 레지스터 속의 명령어를 받아들이고 이를 해석한 뒤 제어 신호를 내보냄

#### 메모리 주소 레지스터(MAR; Memory Address Register)

- 메모리의 주소를 저장하는 레지스터
- CPU가 읽어 들이고자 하는 주소 값을 주소 버스로 보낼 때 메모리 주소 레지스터를 거침

#### 메모리 버퍼 레지스터(MBR; Memory Buffer Register, MDR; Memory Data Register)

- 메모리와 주고받을 값(데이터와 명령어)을 저장하는 레지스터
- 메모리에 쓰고 싶은 값이나 메모리로부터 전달받은 값은 메모리 버퍼 레지스터를 거침
- CPU가 주소 버스로 내보낼 값은 메모리 주소 레지스터를 거치고, 데이터 버스로 주고받을 값은 메모리 버퍼 레지스터를 거침

#### 범용 레지스터(general purpose register)

- 다양하고 일반적인 상황에서 자유롭게 사용할 수 있는 레지스터

#### 플래그 레지스터(flag register)

- ALU 연산 결과에 따른 플래그를 플래그 레지스터에 저장

### 특정 레지스터를 이용한 주소 지정 방식: 스택 주소 지정 방식

- 스택(stack)과 스택 포인터(stack pointer)를 이용한 주소 지정 방식
- 스택 포인터: 스택에 마지막으로 저장한 값의 위치를 저장하는 레지스터
- 스택은 메모리 안의 스택 영역에 위치

### 특정 레지스터를 이용한 주소 지정 방식: 변위 주소 지정 방식(displacement addressing mode)

- 오퍼랜드 필드의 값(변위)과 특정 레지스터의 값을 더하여 유효 주소를 얻어내는 주소 지정 방식
- 오퍼랜드 필드의 주소와 어떤 레지스터를 더하는지에 따라 상대 주소 지정 방식, 베이스 레지스터 주소 지정 방식 등으로 나뉨

#### 상대 주소 지정 방식(relative addressing mode)

- 오퍼랜드와 프로그램 카운터의 값을 더하여 유효 주소를 얻는 방식
- 프로그래밍 언어의 if문과 유사하게 모든 코드를 실행하는 것이 아닌, 분기하여 특정 주소의 코드를 실행할 때 사용됨

#### 베이스 레지스터 주소 지정 방식(base-register addressing mode)

- 오퍼랜드와 베이스 레지스터의 값을 더하여 유효 주소를 얻는 방식
- 베이스 레지스터는 기준 주소, 오퍼랜드는 기준 주소로부터 떨어진 거리로서의 역할을 수행함

## 4.3 명령어 사이클과 인터럽트

- 명령어 사이클: 하나의 명령어를 처리하는 정형화된 흐름
- 인터럽트: 명령어를 처리하는 일련의 흐름이 끈헝지는 상황

### 명령어 사이클

- 프로그램 속 각각의 명령어들은 명령어 사이클이 반복되며 실행됨
- 인출 사이클(fetch cycle)
    - 메모리에 있는 명령어를 CPU로 가지고 오는 단계
- 실행 사이클(execution cycle)
    - CPU로 가져온 명령어를 실행하는 단계
    - 제어장치가 명령어 레지스터에 담긴 값을 해석하고 제어 신호를 발생시키는 단계
- 간접 사이클(indirect cycle)
    - 명령어를 실행하기 위해서 메모리 접근을 수행하는 단계

### 인터럽트

- CPU의 작업을 방해하는 신호

#### 동기 인터럽트(synchronous interrupts)

- CPU에 의해 발생하는 인터럽트
- CPU가 명령어들을 수행하다가 예상치 못한 상황에 마주쳤을 때 발생하는 인터럽트
- 동기 인터럽트는 예외(exception)라고도 불림

#### 비동기 인터럽트(asynchronous interrupts)

- 주로 입출력장치에 의해 발생하는 인터럽트
- 작업을 끝낸 입출력장치가 CPU에 완료 알림(인터럽트)을 보냄
- 입출력장치가 어떠한 입력을 받아들였을 때 이를 처리하기 위해 CPU에 입력 알림(인터럽트)을 보냄
- 비동기 인터럽트는 하드웨어 인터럽트라고도 불림

#### 하드웨어 인터럽트

- CPU가 입출력장치에 작업을 명령했을 때, 완료 인터럽트를 받을 때까지 다른 작업을 처리할 수 있으므로 명령어를 효율적으로 처리할 수 있음

#### 하드웨어 인터럽트 처리 순서

1. 입출력장치는 CPU에 인터럽트 요청 신호를 보냄
2. CPU는 실행 사이클이 끝나고 명령어를 인출하기 전 항상 인터럽트 여부를 확인
3. CPU는 인터럽트 요청을 확인하고 인터럽트 플래그를 통해 현재 인터럽트를 받아들일 수 있는지 여부를 확인
4. 인터럽트를 받아들일 수 있다면 CPU는 지금까지의 작업을 백업함
5. CPU는 인터럽트 벡터를 참조하여 인터럽트 서비스 루틴을 실행
6. 인터럽트 서비스 루틴 실행이 끝나면 4단계에서 백업해 둔 작업을 복구하여 실행을 재개