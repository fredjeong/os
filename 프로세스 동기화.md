# 12. 프로세스 동기화

## 12.1 동기화란

### 동기화의 의미

- 프로세스 동기화 (process synchronisation)
    - 프로세스들 사이의 수행 시기를 맞추는 것
        - 실행 순서 제어
            - 프로세스를 올바른 순서대로 실행하기
        - 상호 배제
            - 동시에 접근해서는 안 되는 자원에 하나의 프로세스만 접근하게 하기

#### 실행 순서 제어를 위한 동기화

- 동시에 실행되는 프로세스들이 올바른 순서대로 실행하도록 보장
- 예시: Reader 프로세스가 실행되려면 파일 내에 값이 존재해야 한다는 조건이 만족되어야 하므로 Writer 프로세스가 우선 실행되어야 함

#### 상호 배제를 위한 동기화

- 상호 배제 (mutual exclusion)
    - 공유가 불가능한 자원의 동시 사용을 피하기 위해 사용하는 알고리즘
- 동시에 접근해서는 안 되는 자원에 여러 프로세스들이 동시에 접근하지 못하게 보장

### 생산자와 소비자 문제

- 생산자
    - 물건을 계속해서 생산하는 프로세스
    - 버퍼에 물건을 넣은 후 물건의 총합에 해당하는 변수를 1 증가시킴
- 소비자
    - 물건을 게속해서 소비하는 프로세스
    - 버퍼에서 물건을 빼낸 후 물건의 총합에 해당하는 변수를 1 감소시킴
- 생산자 프로세스와 소비자 프로세스가 제대로 동기화되지 않으면 의도와 다른 결과가 나올 수 있음
- 동시에 접근해서는 안되는 자원에 동시에 접근하여 발생하는 문제

### 공유 자원과 임계 구역

- 공유 자원(shared resource)
    - 동시에 실행되는 프로세스들이 함께 공유하는 자원
- 임계 구역(critical section)
    - 동시에 실행하면 문제가 발생하는 자원에 접근하는 코드 영역
- 레이스 컨디션(race condition)
    - 잘못된 실행으로 인해 여러 프로세스가 동시다발적으로 임계 구역의 코드를 실행하여 문제가 발생하는 경우
    - 레이스 컨디션 발생 시 데이터의 일관성이 깨지는 문제가 발생
- 상호 배제를 위한 동기화는 두 개 이상의 프로세스가 임계 구역에 동시에 접근하지 못하도록 관리
- 운영체제가 임계 구역 문제를 해결하기 위해 가지는 원칙
    - 상호 배제(mutual exclusion)
        - 한 프로세스가 임계 구역에 진입했다면 다른 프로세스는 임계 구역에 들어올 수 없음
    - 진행(progress)
        - 임계 구역에 어떤 프로세스도 진입하지 않았다면 임계 구역에 진입하고자 하는 프로세스는 들어갈 수 있어야 함
    - 유한 대기(bounded waiting)
        - 한 프로세스가 임계 구역에 진입하고 싶다면 그 프로세스는 언젠가는 임계 구역에 들어올 수 있어야 함
        - 임계 구역에 들어오기 위해 무한정 대기해서는 안 됨

## 12.2 동기화 기법

### 뮤텍스 락(Mutex lock; MUTual EXclusion lock)

- 상호 배제를 위한 동기화 도구
- 구현 요소
    - 프로세스들이 공유하는 전역 변수 `lock`
    - 임계 구역을 잠그는 `acquire` 함수
        - 프로세스가 임계 구역에 진입하기 전에 호출
        - `lock == False`일 때까지 임계 구역을 반복적으로 확인하고, 임계 구역이 열려 있다면 `lock = True`로 임계 구역을 잠그는 함수
    - 임계 구역의 잠금을 해제하는 `release` 함수
        - 임계 구역에서의 작업이 끝나고 호출
        - `lock = False`로 잠긴 임계 구역을 열어주는 함수
- 프로세스는 락을 획득할 수 없다면, 즉 임계 구역에 진입할 수 없다면 대기하고, 락을 획득할 수 있다면 임계 구역을 잠근 뒤 임계 구역에서의 작업을 진행, 임계 구역에서 빠져나올 때는 다시 임계 구역의 잠금을 해제함으로서 임계 구역을 보호함
- 바쁜 대기(busy wait) 방식
    - 락의 잠금 여부를 반복하여 확인함

### 세마포 (Semaphore)

- 공유 자원이 여러 개 있는 상황에서도 적용이 가능한 동기화 도구
- 프로세스는 임계 구역 앞에서 멈춤 신호를 받으면 잠시 기다리고, 가도 좋다는 신호를 받으면 임계 구역에 진입
- 구현
    - 전역 변수 `S`
        - 임계 구역에 진입할 수 있는 프로세스의 개수(사용 가능한 공유 자원의 개수)를 나타냄
    - `wait` 함수
        - 임계 구역에 들어가도 좋은지, 기다려야 할지를 알려줌
    - `signal` 함수
        - 임계 구역 앞에서 기다리는 프로세스에 임계 구역에 진입해도 된다는 신호를 보냄
- 임계 구역 진입 전후로 `wait()`와 `signal()`이 호출됨
- busy wait 방식이 비효율적이므로 다른 방식을 사용
    - `wait` 함수는 사용할 수 있는 자원이 없을 경우 해당 프로세스를 대기 상태로 만들고, 그 프로세스의 PCB를 세마포를 위한 대기 큐에 집어넣음
    - 다른 프로세스가 임계 구역에서의 작업이 끝나고 `signal` 함수를 호출하면 `signal` 함수는 대기 중인 프로세스를 대기 큐에서 제거하고, 프로세스 상태를 준비 상태로 변경한 뒤 준비 큐로 옮김

### 모니터 (Monitor)

- 매번 임계 구역에 앞뒤로 `wait`와 `signal` 함수를 명시하는 것은 비효율적
- 공유 자원과 공유 자원에 접근하기 위한 인터페이스(통로)를 묶어 관리
- 프로세스는 반드시 인터페이스를 통해서만 공유 자원에 접근하도록 함
- 모니터를 통해 공유 자원에 접근하고자 하는 프로세스를 큐에 삽입하고, 큐에 삽입된 순서대로 하나씩 공유 자원을 이용하도록 함
- 모니터는 공유 자원을 다루는 인터페이스에 접근하기 위한 큐를 만들고, 모니터 안에 항상 하나의 프로세스만 들어오도록 하여 상호 배제를 위한 동기화 제공
- 조건 변수(condition variable)를 이용하여 실행 순서 제어를 위한 동기화 제공