# 8. 입출력장치

## 8.1 장치 컨트롤러와 장치 드라이버

### 장치 컨트롤러

- 입출력장치는 CPU, 메모리보다 다루기가 까다로움
    - 입출력장치의 종류가 너무 많아 다양한 입출력장치와 정보를 주 고받는 방식을 규격화하기 어렵기 때문
    - 일반적으로 CPU와 메모리의 데이터 전송률은 높지만 입출력장치의 데이터 전송률은 낮기 때문
- 따라서 입출력장치는 컴퓨터에 직접 연결되지 않고 장치 컨트롤러(device controller, I/O controller, I/O module)라는 하드웨어를 통해 연결됨
- 모든 입출력장치는 각자의 장치 컨트롤러를 통해 컴퓨터 내부와 정보를 주고받음
- 장치 컨트롤러의 역할
    - CPU와 입출력장치 간의 중개
        - 입출력장치의 종류가 많아 정보 규격화가 어려웠던 문제 해결
        - 장치 컨트롤러가 일종의 번역가 역할을 수행
    - 오류 검출
    - 데이터 버퍼링
        - 전송률이 높은 장치와 낮은 장치 사이에 주고받는 데이터를 임시 저장 공간인 버퍼에 저장하여 전송률을 비슷하게 맞추는 방법
        - 버퍼에 데이터를 조금씩 모았다가 한 번에 내보내거나, 데이터를 한 번에 많이 받아 조금씩 내보내는 방법
        - 장치 컨트롤러는 전송률이 높은 CPU와 전송률이 낮은 입출력장치와의 전송률 차이를 데이터 버퍼링으로 완화
- 장치 컨트롤러의 구조
    - 데이터 레지스터(data register)
        - CPU와 입출력장치 사이에 주고받을 데이터가 담기는 레지스터
        - 데이터 버퍼링을 위한 버퍼 역할을 수행
        - 주고받는 데이터가 많은 입출력장치에서는 레지스터 대신 RAM을 사용하기도 함
    - 상태 레지스터(state register)
        - 입출력장치가 입출력 작업을 할 준비가 되었는지, 입출력 작업이 완료되었는지, 입출력장치에 오류는 없는지 등의 상태 정보를 저장
    - 제어 레지스터(control register)
        - 입출력장치가 수행할 내용에 대한 제어 정보와 명령을 저장

### 장치 드라이버

- 장치 컨트롤러의 동작을 감지하고 제어함으로써 장치 컨트롤러가 컴퓨터 내부와 정보를 주고받을 수 있게 하는 프로그램
- 프로그램이므로 실행 과정에서 메모리에 저장됨
- 입출력장치 연결을 위한 소프트웨어적 통로로서의 역할 수행
- 컴퓨터가 장치 드라이버를 인식하거나 실행할 수 없는 상태라면 그 장치는 컴퓨터 내부와 정보를 주고받을 수 없음

## 8.2 다양한 입출력 방법

### 프로그램 입출력 (Programmed I/O)

- 프로그램 속 명령어로 입출력장치를 제어하는 방법

#### 메모리 맵 입출력 (Memory-Mapped I/O)

- 메모리에 접근하기 위한 주소 공간과 입출력장치에 접근하기 위한 주소 공간을 하나의 주소 공간으로 간주하는 방법
- CPU는 메모리의 주소들이나 장치 컨트롤러의 레지스터들이나 모두 똑같이 메모리 주소처럼 다룰 수 있음
    - 메모리에 접근하는 명령어와 입출력장치에 접근하는 명령어가 다를 필요가 없음

#### 고립형 입출력 (isolated I/O)

- 메모리를 위한 주소 공간과 입출력장치를 위한 주소 공간을 분리하는 방법
- CPU는 입출력장치에 접근하기 위해 메모리에 접근하는 명령어와는 다른 입출력 명령어를 사용함

### 인터럽트 기반 입출력

- CPU는 장치 컨트롤러에 입출력 작업을 명령하고, 장치 컨트롤러가 입출력 작업을 끝낸 뒤 CPU에게 인터럽트 요청 신호를 보내면 CPU는 하던 일을 백업하고 인터럽트 서비스 루틴을 실행함
- 여러 장치에서 인터럽트가 동시에 발생한 경우, CPU는 인터럽트 간에 우선순위를 고려하여 우선순위가 높은 인터럽트 순으로 여러 인터럽트를 처리할 수 있음
- 프로그래머블 인터럽트 컨트롤러(PIC; Programmable Interrupt Controller)
    - 여러 장치 컨트롤러에 연결되어 장치 컨트롤러에서 보낸 하드웨어 인터럽트 요청들의 우선순위를 판별한 뒤 CPU에 지금 처리해야 할 하드웨어 인터럽트는 무엇인지 알려주는 장치
    - 처리 과정
        1. PIC가 장치 컨트롤러에서 인터럽트 요청 신호들을 받아들임
        2. PIC는 인터럽트 우선순위를 판단한 뒤 CPU에 처리해야 할 인터럽트 요청 신호를 보냄
        3. CPU는 PIC에 인터럽트 확인 신호를 보냄
        4. PIC는 데이터 버스를 통해 CPU에 인터럽트 벡터를 보냄
        5. CPU는 인터럽트 벡터를 통해 인터럽트 요청의 주체를 알게 되고, 해당 장치의 인터럽트 서비스 루틴을 실행

### DMA(Direct Memory Access) 입출력

- 입출력장치와 메모리가 CPU를 거치지 않고 상호작용할 수 있는 입출력 방식
- 시스템 버스에 연결된 DMA 컨트롤러라는 하드웨어 필요

#### DMA 입출력 과정

1. CPU는 DMA 컨트롤러에 입출력장치의 주소, 수행할 연산(읽기/쓰기), 읽거나 쓸 메모리의 주소 등과 같은 정보로 입출력 작업을 명령
2. DMA 컨트롤러는 CPU 대신 장치 컨트롤러와 상호작용하며 입출력 작업을 수행하며, 필요한 경우 메모리에 직접 접근하여 정보를 읽거나 씀
3. 입출력 작업이 끝나면 DMA 컨트롤러는 CPU에 인터럽트를 걸어 작업이 끝났음을 알림

### 입출력 버스

- 시스템 버스는 공용 자원이므로 동시 사용이 불가능함
- DMA 컨트롤러는 CPU가 시스템 버스를 이용하지 않을 때마다 조금씩 시스템 버스를 이용하거나, CPU가 일시적으로 시스템 버스를 이용하지 않도록 허락을 구하고 시스템 버스를 집중적으로 이용
- DMA가 시스템 버스를 너무 자주 사용하면 그만큼 CPU가 시스템 버스를 이용하지 못함
- 따라서 DMA 컨트롤러와 장치 컨트롤러들을 입출력 버스(input/output bus)라는 별도의 버스에 연결하여 이들 간의 데이터 전송 시에는 시스템 버스를 이용하지 않도록 하여 시스템 버스의 사용 빈도를 줄임